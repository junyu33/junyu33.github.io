<!DOCTYPE html>
<html lang="en">

  
    <link rel="alternate" hreflang="zh" href="/zh/2022/05/23/pwn_environ3/">
  

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <!-- RSS / Atom -->
  <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  
<link rel="stylesheet" href="/css/style.css">

  <title>现充|junyu33</title>
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div class="head-nav">
	<div class="inner">
		<a href="/">
			现充|junyu33
		</a>
		<div class="right">
			
				<a href="/">Home</a>
				<a href="/archives">Archive</a>
				
					<a href="/categories">Categories</a>
				
				
					<a href="/tags">Tags</a>
				
				<a href="/zh">中文站</a>
			
		</div>
	</div>
</div>

  <div class="main">
    <div class="post">
    
      <nav class="lang-switch" role="navigation" aria-label="Language switch">
        
          <a class="lang-pill"
             href="/zh/2022/05/23/pwn_environ3/"
             hreflang="zh">
            <span class="lang-label">中文</span>
          </a>
        
      </nav>
    

	<h1>How to create an extremely comfortable pwn environment (Season 3)</h1>
	<p>Installing Ubuntu 20.04 on a physical machine and configuring common software and a kernel pwn environment.</p>
<span id="more"></span>
<h1>Installing Ubuntu 20.04</h1>
<h2 id="Creating-a-Bootable-USB-Drive">Creating a Bootable USB Drive</h2>
<p>After downloading the Ubuntu 20.04 ISO file online, use UltraISO to burn the USB drive in RAW format.</p>
<p><strong>Note: It must be RAW format, not something like USB-HDD+ or other options, otherwise the installer won't even boot!</strong></p>
<p>When restarting and entering the BIOS, move the USB drive's boot priority above the <code>hard drive</code>.</p>
<h2 id="Installing-Ubuntu">Installing Ubuntu</h2>
<p>At this point, the system will give you the option to try or install Ubuntu. My approach is to try it first and then click the installation program.</p>
<p>The trial interface functions like a bootable live environment with internet access—you can experience it and then proceed with the installation (<s>or simply shut down</s>).</p>
<p>During the trial, it's recommended to use <code>Gparted</code> to partition your hard drive. Allocate 100 GB at the end of the disk: assign 60 GB on the left for the root directory (<code>/</code>) and 40 GB on the right for the home directory (<code>/home</code>), both formatted as ext4. You can skip creating a swap partition—the only downside is a slightly slower boot time. This way, you won't need to deal with partitioning during the actual installation.</p>
<p>During installation, it's advisable to choose the full installation option <strong>but skip downloading updates</strong> (otherwise, the installation will be extremely slow). Under normal circumstances, the installation should be completed within half an hour.</p>
<h2 id="Change-Sources">Change Sources</h2>
<p><code>sudo vim /etc/apt/sources.list</code></p>
<pre><code class="language-bash"># Add Aliyun source
deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
# Add Tsinghua source
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse multiverse
</code></pre>
<p><code>sudo apt-get update</code></p>
<h2 id="Input-Method">Input Method</h2>
<p>The default input method in Ubuntu works quite well. It's based on iBus and requires minimal configuration.</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43431593/article/details/106444769">https://blog.csdn.net/weixin_43431593/article/details/106444769</a></p>
<h2 id="Setting-Up-a-Proxy">Setting Up a Proxy</h2>
<blockquote>
<p>As is well known, if you already have a ladder, finding another one is easy; but if you don't, it can be quite troublesome.</p>
</blockquote>
<p>If you use a VPN, you may be able to download the China-specific version directly from the official website, saving a lot of trouble.</p>
<p>If you use a proxy service (airport), copying the subscription link is straightforward, but downloading the client from GitHub can be cumbersome. It is recommended to download the Linux version on a previous system and then install it directly on Ubuntu.</p>
<h1>Terminal Environment Configuration</h1>
<blockquote>
<p>Original article: <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41179606/article/details/80957817">https://blog.csdn.net/weixin_41179606/article/details/80957817</a><br>
There was an error in the original article when installing zsh-syntax-highlighting, which the author has corrected.</p>
</blockquote>
<pre><code class="language-bash"># The default path is the user's home directory
# Install zsh
sudo apt-get install zsh
# If an error occurs: Unable to locate package, manually update the software sources
sudo apt-get update
# After installation, switch the shell to zsh
chsh -s /bin/zsh

sudo apt-get install git

sh -c &quot;$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;

# Install autojump
sudo apt-get install autojump
# Open the configuration file
vim .zshrc
# Add the following line at the end
. /usr/share/autojump/autojump.sh

# Install zsh-autosuggestions
git clone git://github.com/zsh-users/zsh-autosuggestions $ZSH_CUSTOM/plugins/zsh-autosuggestions
# Open the configuration file
vim .zshrc
# Add configuration 1
plugins	= (
	git
	zsh-autosuggestions  // Add this line
)
# Add configuration 2 (at the end of the file)
source $ZSH_CUSTOM/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh

# Install zsh-syntax-highlighting
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git
echo &quot;source $&#123;(q-)PWD&#125;/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh&quot; &gt;&gt; $&#123;ZDOTDIR:-$HOME&#125;/.zshrc
source ./zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# Open the configuration file
vim .zshrc
# Modify ZSH_THEME
ZSH_THEME=&quot;ys&quot; or &quot;agnoster&quot;

source ~/.zshrc
</code></pre>
<h1>Software Installation</h1>
<p>Now that you have access and have switched to a faster software source, you no longer need to worry about network issues when installing software or pulling projects.</p>
<h2 id="Software-List">Software List</h2>
<ul>
<li>Chrome</li>
<li>NetEase Music</li>
<li>VirtualBox</li>
<li>VSCode</li>
<li>IntelliJ IDEA</li>
<li>Typora</li>
<li>Albert</li>
<li>FSearch</li>
<li>Python3 (pip3)
<ul>
<li>pwntools</li>
<li>ropgadget, ropper</li>
<li>gdb, peda, gef, pwndbg, pwngdb</li>
</ul>
</li>
<li>Ruby (gem)
<ul>
<li>one_gadget</li>
</ul>
</li>
<li>QEMU</li>
<li>Docker</li>
<li>IDA Pro</li>
<li>Tencent Meeting</li>
<li>WeChat</li>
<li><s>TIM</s></li>
</ul>
<h2 id="Installing-from-APT-Repository">Installing from APT Repository</h2>
<pre><code class="language-bash"># install
sudo apt install *
# OR sudo apt-get install *
# remove
sudo apt remove *
# OR sudo apt-get remove *
</code></pre>
<h2 id="Installing-deb-Files">Installing .deb Files</h2>
<p>Most applications are installed this way</p>
<pre><code class="language-bash"># install
sudo dpkg -i *.deb
# remove
sudo dpkg -r *.deb
</code></pre>
<h2 id="Using-Non-Domestic-Windows-Applications">Using Non-Domestic Windows Applications</h2>
<p>Most can be handled with Wine.</p>
<pre><code class="language-bash">sudo dpkg --add-architecture i386 
wget -nc https://dl.winehq.org/wine-builds/winehq.key
sudo mv winehq.key /usr/share/keyrings/winehq-archive.key
wget -nc https://dl.winehq.org/wine-builds/ubuntu/dists/focal/winehq-focal.sources
sudo mv winehq-focal.sources /etc/apt/sources.list.d/
sudo apt update
sudo apt install --install-recommends winehq-stable
</code></pre>
<p>It still takes up a couple of gigabytes, and the installation is somewhat time-consuming.</p>
<p>However, some configurations for IDA can be quite troublesome, so it's worth writing about here:</p>
<h3 id="IDA-Configuration">IDA Configuration</h3>
<p>It is assumed here that the reader is using the portable version of IDA.</p>
<h4 id="Pitfall-1">Pitfall 1</h4>
<p>Opening IDA directly with Wine seems to cause DLLs to fail loading, which prevents various features of IDA from functioning.</p>
<p>Two scripts were written to specify the Python path:</p>
<pre><code class="language-bat"># start.bat
@set path=.\python-3;%path%
@set PYTHONPATH=.\python-3
@start ida.exe
# start64.bat
@set path=.\python-3;%path%
@set PYTHONPATH=.\python-3
@start ida64.exe
</code></pre>
<p>Then:</p>
<pre><code class="language-bash">wine start.bat
wine start64.bat
</code></pre>
<blockquote>
<p>Occasionally, there are inexplicable errors where IDAPython fails to load. My solution is to create a soft link to the IDA root directory on the desktop, open a shell from the desktop to enter the soft link, and then run these two .bat files with Wine.</p>
<p>However, directly using the absolute path with <code>cd</code> results in an error for unknown reasons.</p>
</blockquote>
<h4 id="Pitfall-2">Pitfall 2</h4>
<p>At this point, IDA itself and IDAPython can function normally, but some plugins, such as <code>findcrypt</code> and <code>keypatch</code>, still encounter issues with missing dependencies like <code>yara</code> and <code>keystone-engine</code>.</p>
<p>The installation method is described in Pitfall 3.</p>
<p><s>Since our Python is the portable version, using <code>pip</code> to install plugins naturally won't work.</s></p>
<p><s>My approach was to first install a <strong>32-bit</strong> Python, <strong>without adding it to the environment variables</strong>, then locate the pip path, run <code>pip install xxx</code>, check which files were added, and manually copy them to the corresponding relative paths in the portable Python directory.</s></p>
<blockquote>
<p><s>A convenient way to see which files were added is to attempt to uninstall the plugin. The shell will then display which files will be deleted—these are the files that were added during installation.</s></p>
</blockquote>
<h4 id="Pitfall-3">Pitfall 3</h4>
<blockquote>
<p>Original link: <a target="_blank" rel="noopener" href="https://github.com/polymorf/findcrypt-yara/issues/34">https://github.com/polymorf/findcrypt-yara/issues/34</a></p>
</blockquote>
<p>Even if you've made it this far, there may still be some issues. For example, when using the <code>findcrypt</code> plugin, errors may occur.</p>
<p>The GitHub solution suggests uninstalling <code>yara</code> and installing <code>yara-python</code>. <s>However, I tried this, and due to the peculiarities of Wine, it didn't seem to work.</s></p>
<p>First, execute <code>get-pip.py</code> with Python, then locate the <code>python38._pth</code> file, add a new line <code>Lib\site-packages</code>, and then you can happily install packages with pip.</p>
<p>A simple and crude solution is to delete this rule in <code>findcrypt3.rules</code>:</p>
<p><img src="https://user-images.githubusercontent.com/37646748/103058572-73556f80-45dd-11eb-9ebf-b4a4c1a2e25a.png" alt=""></p>
<h2 id="Trying-Out-Domestic-Windows-Applications">Trying Out Domestic Windows Applications</h2>
<h3 id="NetEase-Cloud-Music">NetEase Cloud Music</h3>
<blockquote>
<p>Deepin is the GOAT (Greatest of All Time)!</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.deepin.org/zh/cooperative/netease-cloud-music/">https://www.deepin.org/zh/cooperative/netease-cloud-music/</a></p>
<h3 id="Tencent-Meeting">Tencent Meeting</h3>
<p>There is a native Linux version, probably because DingTalk has a Linux version, so Tencent was willing to develop a native one.</p>
<h3 id="WeChat">WeChat</h3>
<h4 id="Native-Version-for-Ubuntu-Kylin-Untested">Native Version for Ubuntu Kylin (Untested)</h4>
<p><a target="_blank" rel="noopener" href="https://www.ubuntukylin.com/applications/106-cn.html">https://www.ubuntukylin.com/applications/106-cn.html</a></p>
<h4 id="Using-Deepin-Wine">Using Deepin Wine</h4>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40756508/article/details/107511334">https://blog.csdn.net/qq_40756508/article/details/107511334</a></p>
<h3 id="tim-qq"><s>tim/qq</s></h3>
<h4 id="Official-Ancient-Native-Version">Official Ancient Native Version</h4>
<p><a target="_blank" rel="noopener" href="https://im.qq.com/linuxqq/index.html">https://im.qq.com/linuxqq/index.html</a></p>
<p>QR code scanning doesn't work, dammit.</p>
<h4 id="deepinwine">deepinwine</h4>
<p>Crashes very easily, basically crashes right after login.</p>
<p>No good solution for now.</p>
<h4 id="docker">docker</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/top-bettercode/docker-qq">https://github.com/top-bettercode/docker-qq</a></p>
<p>Change all instances of <code>fcitx</code> to <code>ibus</code> in the startup script to enable Chinese input.</p>
<p>Tested and working on June 13, 2022.</p>
<p>Drawback: Received files cannot be opened directly; they must be copied out from the virtual environment using the docker shell.</p>
<pre><code class="language-bash"># 10f0ec600caf is the container ID, which can be obtained via the sudo docker ps command
sudo docker cp 10f0ec600caf:'/TencentFiles/2658799217/FileRecv/RV.rar' ~/Desktop
</code></pre>
<h1>Kernel Pwn Environment Setup</h1>
<blockquote>
<p>Some content sourced from <a target="_blank" rel="noopener" href="https://kiprey.gitee.io/2021/10/kernel_pwn_introduction/">https://kiprey.gitee.io/2021/10/kernel_pwn_introduction/</a></p>
</blockquote>
<h2 id="Kernel-Download-and-Compilation">Kernel Download and Compilation</h2>
<p>Here is a project that packages the entire process of downloading, extracting, compiling, and packaging the rootfs, making it very convenient.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pwncollege/pwnkernel">https://github.com/pwncollege/pwnkernel</a></p>
<pre><code class="language-bash">git clone https://github.com/pwncollege/pwnkernel.git
./build.sh
./launch.sh
# Since launch.sh includes the operation to package the rootfs, you only need to place the compiled drivers into the _install folder.
</code></pre>
<h2 id="gdb-attach-and-Debugging">gdb attach and Debugging</h2>
<pre><code class="language-bash"># Always specify the architecture in advance
set architecture i386:x86-64
gef-remote --qemu-mode localhost:1234

# After QEMU is suspended with the -S parameter, type the following commands in gdb
add-symbol-file vmlinux
b start_kernel
continue

[Breakpoint 1, start_kernel () at init/main.c:837]
......
</code></pre>
<h2 id="Startup-Script-Untested">Startup Script (Untested)</h2>
<pre><code class="language-bash">#! /bin/bash

# Check if the current user has root privileges, which are required to execute gef-remote --qemu-mode
user=$(env | grep &quot;^USER&quot; | cut -d &quot;=&quot; -f 2)
if [ &quot;$user&quot; != &quot;root&quot;  ]
  then
    echo &quot;Please run with root privileges&quot;
    exit
fi

# Copy drivers to rootfs
cp ./mydrivers/*.ko busybox-1.32.0/_install

# Build rootfs
pushd busybox-1.32.0/_install
find . | cpio -o --format=newc &gt; ../../rootfs.img
popd

# Start qemu
qemu-system-x86_64 \
    -kernel ./arch/x86/boot/bzImage \
    -initrd ./rootfs.img \
    -append &quot;nokaslr&quot; \
    -s  \
    -S&amp;

    # -s: Equivalent to -gdb tcp::1234, specifies the debugging connection for qemu
    # -S: Specifies that qemu should suspend immediately after startup

    # -nographic                # Disable QEMU graphical interface
    # -append &quot;console=ttyS0&quot;   # Used with -nographic, the startup interface becomes the current terminal

gnome-terminal -e 'gdb -x mygdbinit'
</code></pre>
<p>mygdbinit:</p>
<pre><code class="language-bash">set architecture i386:x86-64
add-symbol-file vmlinux
gef-remote --qemu-mode localhost:1234

b start_kernel
c
</code></pre>
<h2 id="Upload-Script">Upload Script</h2>
<blockquote>
<p>Taken from the school competition, to be used with exp.c in this directory.</p>
</blockquote>
<pre><code class="language-python">#!/usr/bin/python
from pwn import *

HOST = &quot;127.0.0.1&quot;
PORT =  25000

USER = &quot;pwn&quot;
PW = &quot;pwn&quot;

def compile():
    # sudo apt install musl-tools
    log.info(&quot;Compile&quot;)
    os.system(&quot;musl-gcc -w -s -masm=intel  -static -o3 exp.c -o pwn&quot;)

def exec_cmd(cmd):
    r.sendline(cmd)
    r.recvuntil(&quot;$ &quot;)

def upload():
    p = log.progress(&quot;Upload&quot;)

    with open(&quot;pwn&quot;, &quot;rb&quot;) as f:
        data = f.read()

    encoded = base64.b64encode(data)
    
    r.recvuntil(&quot;$ &quot;)
    
    for i in range(0, len(encoded), 300):
        p.status(&quot;%d / %d&quot; % (i, len(encoded)))
        exec_cmd(&quot;echo \&quot;%s\&quot; &gt;&gt; benc&quot; % (encoded[i:i+300]))
        
    exec_cmd(&quot;cat benc | base64 -d &gt; bout&quot;)    
    exec_cmd(&quot;chmod +x bout&quot;)
    
    p.success()

def exploit(r):
    compile()
    upload()
    context.log_level = &quot;debug&quot;
    r.interactive()

    return

if __name__ == &quot;__main__&quot;:
    if len(sys.argv) &gt; 1:
        # session = ssh(USER, HOST, PORT, PW)
        # r = session.run(&quot;/bin/sh&quot;)
        HOST = &quot;43.155.90.127&quot;
        PORT = 25000 
        r = remote(HOST, PORT)
        exploit(r)
    else:
        r = process(&quot;./boot.sh&quot;)
        print(util.proc.pidof(r))
        pause()
        exploit(r)
</code></pre>

</div>


  </div>
</body>
</html>

