<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <!-- RSS / Atom -->
  <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>

  
<link rel="stylesheet" href="/css/style.css">

  <title>现充|junyu33</title>
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div class="head-nav">
	<div class="inner">
		<a href="/">
			现充|junyu33
		</a>
		<div class="right">
			
				<a href="/zh">首页</a>
				<a href="/zh/archives">归档</a>
				
					<a href="/zh/categories">Categories</a>
				
				
					<a href="/zh/tags">Tags</a>
				
				<a href="/">English</a>
			
		</div>
	</div>
</div>

  <div class="main">
    <div class="post">
    

	<h1>从零搭建一个又快又安全的 VNC 服务</h1>
	<p>因为笔者的寝室电脑有公网 IP，而市面上的远程桌面软件因为使用中继服务器延迟较高，并且个人不信任它们的安全性，所以决定自己搭建一个 VNC 服务。</p>
<p>这样就可以从实验室低延迟的连回寝室电脑，并且保证一定的安全性。</p>
<p>至少让 TigerVNC 觉得 “Connection is secure” without any exemption.</p>
<span id="more"></span>
<h1>Prerequisites</h1>
<ul>
<li>你自己的域名。</li>
<li>公网 IP（理论上 IPv4 和 IPv6 均可，本文以 IPv4 为例）。</li>
</ul>
<h1>Steps</h1>
<h2 id="申请-DDNS">申请 DDNS</h2>
<p>我的域名是在 <a target="_blank" rel="noopener" href="https://www.namecheap.com/">Namecheap</a> 买的，但我把自己的 DNS 服务托管给了 <a target="_blank" rel="noopener" href="https://www.netlify.com">Netlify</a>。如果你也是这样，那么你可以使用 <a target="_blank" rel="noopener" href="https://github.com/oscartbeaumont/netlify-dynamic-dns">Netlify Dynamic DNS</a> 来自动化 DDNS 的流程。当然，如果你是 <a target="_blank" rel="noopener" href="https://www.cloudflare.com/">Cloudflare</a> 的用户，网上的教程应该更多，这里就不赘述了。以下是自己的代码：</p>
<pre><code class="language-sh">#!/bin/bash

# Configuration
ACCESSTOKEN=&quot;&lt;access_token&gt;&quot;                 # Netlify API access token
ZONE=&quot;example.com&quot;                           # Domain name (Netlify DNS zone)
RECORD=&quot;subdomain&quot;                           # Subdomain (subdomain.example.com)

# Get the current public IPv4 (without using proxy)
IP=$(curl --noproxy '*' -s http://ipv4.icanhazip.com)

# Disable IPv6 updates and ensure no proxy for Netlify requests
NDDNS_IPv6_ENABLED=false no_proxy=&quot;*.netlify.com&quot; nddns_linux -accesstoken &quot;$ACCESSTOKEN&quot; -zone &quot;$ZONE&quot; -record &quot;$RECORD&quot;

# Log the update
echo &quot;$(date): Updated $RECORD.$ZONE to IP $IP&quot;
</code></pre>
<p>然后在 systemd 启用定时任务：</p>
<pre><code class="language-sh">~/Desktop/tmp                                                                                                                                                                 10m 8s 22:12:16
&gt; cat /etc/systemd/system/ddns-update.service
[Unit]
Description=Run DDNS update script

[Service]
Type=oneshot
Environment=&quot;http_proxy=&lt;http_proxy&gt;&quot;                 # If you need proxy
Environment=&quot;https_proxy=&lt;https_proxy&gt;&quot;               # If you need proxy
ExecStart=/bin/bash /home/junyu33/Desktop/tmp/ddns.sh

~/Desktop/tmp                                                                                                                                                                        22:12:42
&gt; cat /etc/systemd/system/ddns-update.timer  
[Unit]
Description=Run DDNS update script every 30 minutes

[Timer]
OnBootSec=5min
OnUnitActiveSec=30min
Persistent=true

[Install]
WantedBy=timers.target
</code></pre>
<p>这样，你的域名就会多一条 TXT 记录，记录着你电脑的公网 IP。</p>
<p>如果你的电脑此时开启了 sshd，你应该可以使用 <code>ssh user@subdomain.example.com</code> 连上自己电脑了。</p>
<h2 id="安装-TigerVNC-服务">安装 TigerVNC 服务</h2>
<p>参考这篇文章：<a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-20-04</a></p>
<blockquote>
<p>看到 Step 2 为止，虽然 Step 3 确实可以达到实际上的安全性，但是 TigerVNC 的客户端会认为连接不安全。</p>
</blockquote>
<p>然后这篇文章只提到的 TigerVNC 的服务端安装，客户端在 xubuntu 的安装命令为：</p>
<pre><code class="language-sh">sudo apt install tigervnc-viewer
</code></pre>
<h2 id="完成-certbot-DNS-01-challenge-以获得证书">完成 certbot DNS-01 challenge 以获得证书</h2>
<p>xubuntu 的 certbot 包似乎有问题，我选择 conda 虚拟环境下的 certbot pip 包：</p>
<pre><code class="language-sh">pip3 install certbot
certbot certonly --manual --preferred-challenges dns --config-dir ~/Desktop/tmp --work-dir ~/Desktop/tmp --logs-dir ~/Desktop/tmp -d subdomain.example.com
</code></pre>
<p>然后按照提示添加 TXT 记录即可。</p>
<p>完成后你会在 <code>~/Desktop/tmp/archive/subdomain.example.com/</code> 下看到证书文件。</p>
<pre><code class="language-sh">&gt; /bin/ls -al           
total 16
drwxrwxr-x 1 junyu33 junyu33   90 Sep 22 20:45 .
drwx------ 1 junyu33 junyu33   48 Sep 22 20:45 ..
-rw-rw-r-- 1 junyu33 junyu33 1273 Sep 22 20:45 cert1.pem
-rw-rw-r-- 1 junyu33 junyu33 1566 Sep 22 20:45 chain1.pem
-rw-rw-r-- 1 junyu33 junyu33 2839 Sep 22 20:45 fullchain1.pem
-rw------- 1 junyu33 junyu33  241 Sep 22 20:45 privkey1.pem
</code></pre>
<h2 id="配置-TigerVNC-安全连接">配置 TigerVNC 安全连接</h2>
<p>将你的 certbot 证书复制到 <code>~/.vnc/</code> 下：</p>
<pre><code class="language-sh"># 服务器证书和私钥
cp ~/Desktop/tmp/archive/subdomain.example.com/cert1.pem ~/.vnc/subdomain.example.com-SrvCert.pem
cp ~/Desktop/tmp/archive/subdomain.example.com/privkey1.pem ~/.vnc/subdomain.example.com-SrvKey.pem
</code></pre>
<blockquote>
<p>这里的 pem 文件前缀不一定是 <code>subdomain.example.com</code>，但是之后 TigerVNC启动时，必须要指定正确的 pem 文件。</p>
</blockquote>
<p>然后重启 TigerVNC 服务：</p>
<pre><code class="language-sh">vncserver -kill :2
vncserver -SecurityTypes=X509Vnc -X509Cert=/home/junyu33/.vnc/subdomain.example.com-SrvCert.pem \
          -X509Key=/home/junyu33/.vnc/subdomain.example.com-SrvKey.pem -localhost=no -geometry=1920x1080 :2
</code></pre>
<p>然后将 <code>chain1.pem</code> 复制到<strong>客户机</strong>的 <code>~/.vnc/</code> 下：</p>
<pre><code class="language-sh"># 客户机证书链
scp ~/Desktop/tmp/archive/subdomain.example.com/chain1.pem user@client.com:~/.vnc/chain1.pem
</code></pre>
<p>并修改<strong>客户机</strong>的 <code>~/.vnc/default.tigervnc</code>，确保这一行的值正确（没有就加一行）：</p>
<pre><code class="language-sh">X509CA=/home/junyu33/.vnc/chain1.pem
</code></pre>
<p>这个时候启动 TigerVNC，应该会直接看到 “Connection is secure” 的字样并让你输入密码，大功告成。</p>
<h1>FAQ</h1>
<h2 id="问题零（无法连接）：">问题零（无法连接）：</h2>
<img src='https://img.junyu33.me/blog/vnc/Screenshot_2024-09-22_23-00-47.png'>
<ul>
<li>看看你的 DDNS 挂了没。</li>
<li>看看你的防火墙关了没。</li>
<li>看看你的 TigerVNC 服务启动了没。</li>
</ul>
<h2 id="问题一（unknown-authority，无-Let-s-Encrypt）：">问题一（unknown authority，无 Let's Encrypt）：</h2>
<img src='https://img.junyu33.me/blog/vnc/Screenshot_2024-09-22_22-44-30.png'>
<p>TigerVNC 使用了你系统的自签名证书，而不是 Let's Encrypt 的证书。你可以在启动 log 中找到如下字段：</p>
<pre><code>You will require a certificate to use X509None, X509Vnc, or X509Plain.
I will generate a self signed certificate for you in /home/junyu33/.vnc/&lt;hostname&gt;-SrvCert.pem.
</code></pre>
<p>可能是因为你敲重启 TigerVNC 命令的时候没有加 <code>-X509Key</code> 和 <code>-X509Cert</code> 参数。</p>
<h2 id="问题二（域名和证书不匹配）：">问题二（域名和证书不匹配）：</h2>
<img src='https://img.junyu33.me/blog/vnc/Screenshot_2024-09-22_22-43-45.png'>
<p>原因大概跟上一个问题相同，敲重启 TigerVNC 命令的时候没有加 <code>-X509Key</code> 和 <code>-X509Cert</code> 参数。从而使用了你自签的证书，你电脑的 hostname 自然和你连接的服务器不同。</p>
<p>另一种原因是，你 certbot 申请的域名和你的 hostname 不匹配。<strong>必须是完全一致的域名，父域名和子域名都要一致。</strong></p>
<h2 id="问题三（unknown-authority，有-Let-s-Encrypt）：">问题三（unknown authority，有 Let's Encrypt）：</h2>
<img src='https://img.junyu33.me/blog/vnc/Screenshot_2024-09-22_21-42-35.png'>
<p>你的 <code>.vnc</code> 目录下的 <code>chain1.pem</code> 文件没有复制正确（或者在<strong>客户机</strong>不存在），或者你的 <code>default.tigervnc</code> 文件没有配置正确。</p>
<h2 id="问题四（TLS初始化错误）：">问题四（TLS初始化错误）：</h2>
<img src='https://img.junyu33.me/blog/vnc/Screenshot_2024-09-22_22-57-33.png'>
<p>检查一下拷贝证书和私钥的路径是否正确，是不是拷了两个证书或者两个私钥。</p>
<h2 id="问题五（TigerVNC-启动问题）：">问题五（TigerVNC 启动问题）：</h2>
<pre><code class="language-sh">&gt; vncserver                                

New Xtigervnc server '&lt;hostname&gt;:3 (junyu33)' on port 5903 for display :3.
Use xtigervncviewer -SecurityTypes VncAuth -passwd /tmp/tigervnc.E2491i/passwd :3 to connect to the VNC server.


=================== tail /home/junyu33/.vnc/&lt;hostname&gt;:3.log ===================
The XKEYBOARD keymap compiler (xkbcomp) reports:
&gt; Warning:          Could not resolve keysym XF86CameraAccessEnable
&gt; Warning:          Could not resolve keysym XF86CameraAccessDisable
&gt; Warning:          Could not resolve keysym XF86CameraAccessToggle
&gt; Warning:          Could not resolve keysym XF86NextElement
&gt; Warning:          Could not resolve keysym XF86PreviousElement
&gt; Warning:          Could not resolve keysym XF86AutopilotEngageToggle
&gt; Warning:          Could not resolve keysym XF86MarkWaypoint
&gt; Warning:          Could not resolve keysym XF86Sos
&gt; Warning:          Could not resolve keysym XF86NavChart
&gt; Warning:          Could not resolve keysym XF86FishingChart
&gt; Warning:          Could not resolve keysym XF86SingleRangeRadar
&gt; Warning:          Could not resolve keysym XF86DualRangeRadar
&gt; Warning:          Could not resolve keysym XF86RadarOverlay
&gt; Warning:          Could not resolve keysym XF86TraditionalSonar
&gt; Warning:          Could not resolve keysym XF86ClearvuSonar
&gt; Warning:          Could not resolve keysym XF86SidevuSonar
&gt; Warning:          Could not resolve keysym XF86NavInfo
Errors from xkbcomp are not fatal to the X server
X connection to :3 broken (explicit kill or server shutdown).
 ComparingUpdateTracker: 0 pixels in / 0 pixels out
 ComparingUpdateTracker: (1:-nan ratio)
Killing Xtigervnc process ID 8172... success!
=========================================================================

Session startup via '/etc/X11/Xtigervnc-session' cleanly exited too early (&lt; 3 seconds)!

Maybe try something simple first, e.g.,
	tigervncserver -xstartup /usr/bin/xterm
The X session cleanly exited!
The Xtigervnc server cleanly exited!
</code></pre>
<p>这个错误比较棘手，我也没找到根本原因。</p>
<p>我的情况是 <code>/usr/bin/xterm</code> 可以正常运行，然后我在 debug 的时候尝试让 TigerVNC 在 <code>:0</code> 上启动（一般是 <code>:1</code> 和 <code>:2</code>)，导致 xfce4 界面报错。我没有仔细看错误框，导致系统删除了任务栏的一些图标，而我并不会还原这些图标，干脆用 btrfs 把 <code>/home</code> 回滚了。</p>
<p>神奇的是，回滚 <code>/home</code> 后，这个问题就消失了。</p>
<h2 id="问题六（The-authentication-mechanism-requested-cannot-be-provided-by-the-computer）：">问题六（The authentication mechanism requested cannot be provided by the computer）：</h2>
<p>这是在手机的 RVNC Viewer 客户端中出现的错误。奇怪的是，如果不使用加密，手机客户端是可以连接的（当然也会报连接不安全的错误）。</p>
<p>但其实，我基本上也不会在手机上使用 VNC，所以这个问题就不管了。</p>

</div>


  </div>
</body>
</html>

